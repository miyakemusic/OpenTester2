package org.opentester.project;

import java.security.Principal;
import java.util.List;
import java.util.Map;

import org.opentester.project.dto.ProjectTestItemTemplateDto;
import org.opentester.project.dto.ProjectTesterTemplateDto;
import org.opentester.project.dto.TesterSupplierDto;
import org.opentester.project.entity.DtoConverter;
import org.opentester.project.entity.ProjectTestItemTemplateEntity;
import org.opentester.project.entity.ProjectTesterSupplierEntity;
import org.opentester.project.entity.ProjectTesterTemplateEntity;
import org.opentester.project.repository.ProjectTestItemTemplateRepository;
import org.opentester.project.repository.ProjectTesterSupplierRepository;
import org.opentester.project.repository.ProjectTesterTemplateRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class AutomatedHtmlController {
	@Autowired
	private ProjectTesterSupplierRepository projectTesterSupplierRepository;

	@Autowired
	private ProjectTesterTemplateRepository projectTesterTemplateRepository;

	@Autowired
	private ProjectTestItemTemplateRepository projectTestItemTemplateRepository;

	
	@Autowired
	private EntityResourceManager entityResourceManager;
	
	@GetMapping("/admin/project_table_html/{type}")
	public String project_table_html(Model model, Principal principal, @PathVariable("type") String type) {
		return entityResourceManager.getTable(type);
	}
	
	@GetMapping("/admin/project_dialog_html/{type}/{id}")
	public String project_dialog_html(Model model, Principal principal, @PathVariable("type") String type, @PathVariable(value = "id") Long id) {
		return entityResourceManager.getDialogHtml(type, id);
	}
	
	@DeleteMapping("/admin/project_dialog_html/{type}/{id}")
	public String project_dialog_html_del(Model model, Principal principal, @PathVariable("type") String type, @PathVariable(value = "id") Long id) {
		entityResourceManager.delete(type, id);
		
		return "OK";
	}
	
	@GetMapping("/admin/project_dialog_html/{type}")
	public String project_dialog_html(Model model, Principal principal, @PathVariable("type") String type) {
		return entityResourceManager.getDialogHtml(type, null);
	}
	
	@GetMapping("/api/project/admin/select_html/{type}")
	public String select_html(Model model, Principal principal, @PathVariable("type") String type) {
		return entityResourceManager.getSelectionHtml(type);
	}
	
	@PostMapping("/api/project/admin/testerSupplier")
	public String supplier(Principal principal, @RequestBody TesterSupplierDto dto) {
		this.projectTesterSupplierRepository.save(ProjectTesterSupplierEntity.builder()
				.id(dto.getId())
				.name(dto.getName())
				.url(dto.getUrl())
				.build());
		return "OK";
	}
	
	@PostMapping("/api/project/admin/testerTemplate")
	public String testerTemplate(Principal principal, @RequestBody ProjectTesterTemplateDto dto) {
		this.projectTesterTemplateRepository.save(ProjectTesterTemplateEntity.builder()
				.id(dto.getId())
				.keyword(dto.getKeyword())
				.model(dto.getModel())
				.supplier(projectTesterSupplierRepository.findById(dto.getSupplier().getKey()).get())
		//		.testItemTemplates(null)
				.build());
		return "OK";
	}
	
	@PostMapping("/api/project/admin/testItemTemplate")
	public String testItemTemplate(Principal principal, @RequestBody ProjectTestItemTemplateDto dto) {
		this.projectTestItemTemplateRepository.save(ProjectTestItemTemplateEntity.builder()
				.id(dto.getId())
				.description(dto.getDescription())
				.testkey(dto.getKey())
				.unit(dto.getUnit())
				.build());
		return "OK";
	}	
}
