package org.opentester.project.entity;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

import org.opentester.project.TempDB;
import org.opentester.project.dto.DutDto;
import org.opentester.project.dto.DutPackageDto;
import org.opentester.project.dto.ProjectDto;
import org.opentester.project.dto.ProjectTestItemTemplateDto;
import org.opentester.project.dto.ProjectTesterDto;
import org.opentester.project.dto.ProjectTesterTemplateDto;
import org.opentester.project.dto.ProjectUserDto;
import org.opentester.project.dto.TestItemDto;
import org.opentester.project.dto.TestPointDto;

public class DtoConverter {
	public static final SimpleDateFormat dateFormatter = new SimpleDateFormat("yyyy/MM/dd");
	
	public static TestPointDto convertDto(TestPoint testPoint) {
		List<TestItemDto> testItems = new ArrayList<>();
		testPoint.getTestItems().forEach(t -> testItems.add(convertDto(t)));;
		String status = createStatus(testPoint.passFail());
		return TestPointDto.builder().id(testPoint.getId()).name(testPoint.getName())
			.status(status)
			.operator(convertOperatorText2(testPoint.allOperators()))
			.location(testPoint.getLocation())
			.summary(testPoint.getTestItems().size() + " TEST ITEMS")
			.completeDueDate(formatDate(testPoint.completeDueDate()))
			.testItems(testItems)
			.passed(testPoint.passFail().getPassed()).failed(testPoint.passFail().getFailed()).untouched(testPoint.passFail().getUntouched())
					.build();
	}
	
	public static String convertOperatorText(Set<ProjectUser> operators) {
		String operator = operators.size() + " people ";
		Set<String> team = new HashSet<>();
		for (ProjectUser user : operators) {
			team.add(user.overview());
		}
		operator += team.toString();
		return operator;
	}
	
	public static String convertOperatorText2(Set<ProjectUser> operators) {
		String operator = "";
		Set<String> team = new HashSet<>();
		for (ProjectUser user : operators) {
			team.add(user.middle());
		}
		operator += team.toString();
		return operator;
	}
	
	public static String formatDate(Date date) {
		if (date == null) {
			return "";
		}
		else {
			return dateFormatter.format(date);
		}
	}

	public static ProjectDto convertDto(Project p) {
		Set<ProjectUser> operators = p.allOperators();
		String operator = convertOperatorText(operators);
		PassFail passFail = p.passFail();
		String status = createStatus(passFail);
		ProjectDto dto = ProjectDto.builder().id(p.getId()).name(p.getProjectName()).type(p.getType())
				.completeDueDate(formatDate(p.completeDueDate()))
				.completeDate(formatDate(p.completeData()))
				.status(status)
				.operator(operator)
				.location(p.allLocations().toString())
				.passed(passFail.getPassed()).failed(passFail.getFailed()).untouched(passFail.getUntouched())
				.build();
		return dto;
	}

	private static String createStatus(PassFail passFail) {
		String status = "";
		if (passFail.percentage() == 0) {
			status = "NOT STARTED";
		}
		else if (passFail.getUntouched() > 0) {
			status = "ON-GOING, " + passFail.percentage() + "%";
		}
		else {
			status = "COMPLETED";
		}
		return status;
	}

	public static DutPackageDto convertDto(DutPackage dutPackage) {
		PassFail passFail = dutPackage.passFail();
		String status = createStatus(passFail);
		DutPackageDto dto = DutPackageDto.builder().id(dutPackage.getId()).name(dutPackage.getName())
				.status(status)
				.summary(dutPackage.getDuts().size() + " FIBERS," + dutPackage.testPointCount() + " TEST POINTS")
				.operator(convertOperatorText(dutPackage.allOprerators()))
				.completeDueDate(formatDate(dutPackage.comleteDueDate()))
				.completeDate(formatDate(dutPackage.comleteDate()))
				.location(dutPackage.allLocations().toString())
				.passed(passFail.getPassed()).failed(passFail.getFailed()).untouched(passFail.getUntouched()).build();
		
		return dto;
	}

	public static DutDto convertDto(Dut dut) {
		PassFail passFail = dut.passFail();
		List<TestPointDto> testPoints = new ArrayList<>();
		dut.getTestPoints().forEach(p -> testPoints.add(DtoConverter.convertDto(p)));
		String status = createStatus(passFail);
		
		DutDto dto = DutDto.builder().name(dut.getDutName()).id(dut.getId())
			.summary(dut.getTestPoints().size() + " Test Points, " + dut.totalTestItemCount() + " Test Items")
			.completeDueDate(formatDate(dut.completeDueDate()))
			.completeDate(formatDate(dut.completeDate()))	
			.operator(convertOperatorText2(dut.allOperators()))
			.location(dut.allLocations().toString())
			.status(status)
			.testPoints(testPoints)
			.passed(passFail.getPassed()).failed(passFail.getFailed()).untouched(passFail.getUntouched()).build();
		return dto;
	}

	public static TestItemDto convertDto(TestItem testItem) {
		String history = "";
		if (testItem.getResultHistory() == null) {
			history = "-";
		}
		else {
			for (int i = 0; i < testItem.getResultHistory().size()-1; i++) {
				TestResult testResult = testItem.getResultHistory().get(i);
				history += "[Result=" + testResult.getResult() + "@" + testResult.getDate() + "]";
			}
		}
		TestItemDto dto = TestItemDto.builder().id(testItem.getId())
				.testTarget(testItem.getCriteria().getTestItemTemplate().getTarget())
				.completeDate(formatDate(testItem.getCompleteDate()))	
				.unit(testItem.getCriteria().getTestItemTemplate().getUnit())
				.criteria(testItem.getCriteria().getCriteriaFormula())
				.status(testItem.status()).completeDueDate(formatDate(testItem.getCompleteDueDate()))
				.operator(testItem.getOperator().middle())
				.name(testItem.getCriteria().getTestItemTemplate().getName())
				.history(history)
				.build();
		
		if (testItem.getResultHistory() != null && testItem.getResultHistory().size()> 0) {
			TestResult testResult = testItem.getResultHistory().get(testItem.getResultHistory().size()-1);
			dto.setResult(testResult.getResult());
			dto.setCompleteDate(formatDate(testResult.getDate()));
			dto.setOperator(testResult.getOperator().middle());
			dto.setTester(testResult.getTester().getTesterTemplate().getModel() + "/" + testResult.getTester().getTesterTemplate().getSupplier() + "/" + testResult.getTester().getSerialNumber());
			if (testResult.getRawData() != null) {
				dto.setRawData(testResult.getRawData().getId());
				dto.setRawDataName(testResult.getRawData().getName());
			}
		}
		return dto;
	}

	public static List<ProjectTesterDto> convertDto(List<ProjectTester> testers) {
		List<ProjectTesterDto> ret = new ArrayList<>();
		testers.forEach(t -> ret.add(
				ProjectTesterDto.builder().id(t.getId()).model(t.getTesterTemplate().getModel())
					.suplier(t.getTesterTemplate().getSupplier()).serialNumber(t.getSerialNumber())
					.status(t.getStatus())
					.keyword(t.getTesterTemplate().getKeyword())
					.currentUser(t.getCurrentUser() != null ? t.getCurrentUser().getUsername() : "")
					.history(t.getHistory().toString())
					.ability(t.getTesterTemplate().getTestItemTemplates().toString())
					.reservedFrom(formatDate(t.getReservedFrom()))
					.reservedTo(formatDate(t.getReservedTo()))
					.build()));
		return ret;
	}

	public static ProjectUserDto convertDto(ProjectUser user) {
		List<Project> projects = TempDB.instance().projects().stream().filter(p -> p.allOperators().contains(user)).collect(Collectors.toList());
		
		for (Project p : projects) {
			p.getProjectName();
		}
		List<String> assignedProject = projects.stream().map(p -> p.getProjectName()).collect(Collectors.toList());
		
		List<ProjectTester> testers = TempDB.instance().testers();
		
		List<String> belongings = testers.stream().filter(p -> p.getCurrentUser() != null).filter(p -> p.getCurrentUser().getId() == user.getId()).map(p -> p.getTesterTemplate().getModel() + "/" + p.getSerialNumber()).collect(Collectors.toList());
//		.filter(p -> p.getCurrentUser().getId() == user.getId())

		
		ProjectUserDto ret = ProjectUserDto.builder().id(user.getId()).organization(user.getOrganization())
				.fullName(user.getFullName())
				.qualification(user.getQualification())
				.role(user.getRole())
				.assignedProject(assignedProject.toString())
				.belongings(belongings)
				.team(user.getTeam()).username(user.getUsername()).build();
		return ret;
	}

	public static ProjectUserDto[] convertUserDto(List<ProjectUser> users) {
		List<ProjectUserDto> ret = new ArrayList<>();
		users.forEach(u -> ret.add(convertDto(u)));
		return ret.toArray(new ProjectUserDto[0]);
	}

	public static ProjectTesterTemplateDto convertDto(ProjectTesterTemplate testerTemplate) {
		return ProjectTesterTemplateDto.builder().id(testerTemplate.getId()).keyword(testerTemplate.getKeyword())
				.model(testerTemplate.getModel())
				.supplier(testerTemplate.getSupplier())
				.testItemTemplates(testerTemplate.getTestItemTemplates().toString())
				.build();
	}

	public static List<ProjectTesterTemplateDto> convertTesterTemplateDto(List<ProjectTesterTemplate> testerTemplates) {
		return testerTemplates.stream().map(p -> DtoConverter.convertDto(p)).collect(Collectors.toList());	
	}
	
	public static ProjectTestItemTemplateDto convertTestItemTemplateDto(ProjectTestItemTemplate testItemTemplates) {	
		return ProjectTestItemTemplateDto.builder().id(testItemTemplates.getId()).name(testItemTemplates.getName())
				.target(testItemTemplates.getTarget())
				.unit(testItemTemplates.getUnit())
				.build();
	}
	
	public static List<ProjectTestItemTemplateDto> convertTestItemTemplateDto(
			List<ProjectTestItemTemplate> testItemTemplates) {
				
		return testItemTemplates.stream().map(t -> DtoConverter.convertTestItemTemplateDto(t)).collect(Collectors.toList());
	}

}
