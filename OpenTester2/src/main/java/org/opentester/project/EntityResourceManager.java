package org.opentester.project;

import java.lang.reflect.InvocationTargetException;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Optional;
import java.util.Set;

import org.opentester.project.dto.ProjectDto;
import org.opentester.project.dto.TesterSupplierDto;
import org.opentester.project.entity.DtoConverter;
import org.opentester.project.entity.ProjectEntity;
import org.opentester.project.entity.ProjectTesterSupplierEntity;
import org.opentester.project.repository.ProjectRepository;
import org.opentester.project.repository.ProjectTesterSupplierRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;

@Configuration
public class EntityResourceManager {
	private Map<String, EntityResource> map = new LinkedHashMap<>();
	public enum Type {
		project,
		supplier
	}
	@Autowired
	private HtmlGenerator<ProjectDto> projectGenerator;
	@Autowired
	private ProjectRepository projectRepository;

	@Autowired
	private HtmlGenerator<TesterSupplierDto> projectTesterSupplierGenerator;
	@Autowired
	private ProjectTesterSupplierRepository projectTesterSupplierRepository;
	
	public EntityResourceManager() {
		map.put(Type.project.name(), new EntityResource() {
			@Override
			public String getTableHtml() throws NoSuchMethodException, IllegalAccessException, InvocationTargetException {
				return projectGenerator.createTable(
						DtoConverter.convertProjectDto(projectRepository.findAll()), 
						Type.project.name()
						);
			}

			@Override
			public String getDialogHtml(String type, Long id) throws NoSuchMethodException, SecurityException, IllegalAccessException, InvocationTargetException {
				ProjectDto dto = null;
				if (id == null) {
					dto = ProjectDto.builder().name("").build();
				}
				else {
					Optional<ProjectEntity> entity = projectRepository.findById(id);					
					if (entity.isPresent()) {
						dto = DtoConverter.convertDto(entity.get());
					}
				}
				return projectGenerator.createDialog(dto);
			}

			@Override
			public String getPostJson() {
				// TODO Auto-generated method stub
				return null;
			}
			
		});
		map.put(Type.supplier.name(), new EntityResource() {
			@Override
			public String getTableHtml() throws NoSuchMethodException, IllegalAccessException, InvocationTargetException {
				return projectTesterSupplierGenerator.createTable(
						DtoConverter.convertTestSupplier(projectTesterSupplierRepository.findAll()), 
						Type.supplier.name()
						);
			}

			@Override
			public String getDialogHtml(String type, Long id) throws NoSuchMethodException, SecurityException, IllegalAccessException, InvocationTargetException {
				TesterSupplierDto dto = null;
				if (id == null) {
					dto = TesterSupplierDto.builder().name("").build();
				}
				else {
					Optional<ProjectTesterSupplierEntity> entity = projectTesterSupplierRepository.findById(id);					
					if (entity.isPresent()) {
						dto = DtoConverter.convertDto(entity.get());
					}
				}
				return projectTesterSupplierGenerator.createDialog(dto);
			}

			@Override
			public String getPostJson() {
				// TODO Auto-generated method stub
				return null;
			}
			
		});
	}
	public String getTable(String type) {
		try {
			return this.map.get(type).getTableHtml();
		} catch (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return "";
	}
	public String getDialogHtml(String type, Long id) {
		try {
			return this.map.get(type).getDialogHtml(type, id);
		} catch (NoSuchMethodException | SecurityException | IllegalAccessException | InvocationTargetException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return "";
	}
	public Set<String> titles() {
		return this.map.keySet();
	}
};
interface EntityResource {
	public String getTableHtml() throws NoSuchMethodException, IllegalAccessException, InvocationTargetException;
	public String getDialogHtml(String type, Long id) throws NoSuchMethodException, SecurityException, IllegalAccessException, InvocationTargetException;
	public String getPostJson();
}